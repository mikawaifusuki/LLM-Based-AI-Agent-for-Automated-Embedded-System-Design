======================================================================================================================================================

ğŸ” çŠ¶æ€æœºæ­¥éª¤ï¼š
æ­¥éª¤ç¼–å·	æ¨¡å—/å·¥å…·	åŠŸèƒ½æè¿°
S1	CodeGeneratorAgent	æ ¹æ®ç”¨æˆ·è¾“å…¥ç”Ÿæˆåˆç‰ˆ C ä»£ç 
S2	CodeReviewTool	å®¡æŸ¥ C ä»£ç æ ¼å¼ã€é£æ ¼ã€å®‰å…¨æ€§å’Œå¹³å°é€‚é…
S3	ControllerAgent	åˆ¤æ–­æ˜¯å¦éœ€è¦é‡å†™ä»£ç ï¼ˆæ ¹æ® review ä¸¥é‡ç­‰çº§ï¼‰
S4	CodeModifierAgent	æ ¹æ®å®¡æŸ¥æ„è§ä¿®æ”¹ä»£ç 
S5	CodeReviewToolï¼ˆå¤å®¡ï¼‰	å®¡æŸ¥ä¿®æ”¹åçš„ä»£ç 
S6	ControllerAgent	å¦‚æœä»æœ‰ä¸¥é‡é—®é¢˜ â†’ å›åˆ° S4ï¼›å¦åˆ™è¿›å…¥ç¼–è¯‘
S7	CompilerTool	ç¼–è¯‘ä¸º .hex
S8	SimulatorTool	æ‰§è¡Œä»¿çœŸå¹¶åˆ†æç»“æœ


ã€ã€ã€ã€ã€ã€ã€langchainæ§åˆ¶é€»è¾‘ã€‘ã€‘ã€‘ã€‘ã€‘ã€‘

def embedded_agent_pipeline(user_input):
    # Step 1: åˆå§‹ä»£ç ç”Ÿæˆ
    code = CodeGeneratorAgent.run(user_input)

    while True:
        # Step 2: å®¡æŸ¥å½“å‰ä»£ç 
        review = CodeReviewTool.run(code)
        
        # Step 3: åˆ¤æ–­æ˜¯å¦éœ€è¦ä¿®æ”¹
        if contains_severe_issues(review):
            # Step 4: åŸºäºå®¡æŸ¥ç»“æœä¿®æ­£ä»£ç 
            code = CodeModifierAgent.run(code, review)
            continue  # å›åˆ° Step 2 è¿›è¡Œå¤å®¡
        else:
            break  # è‹¥æ— ä¸¥é‡é—®é¢˜ï¼Œè·³å‡ºå¾ªç¯
    
    # Step 5: ç¼–è¯‘
    hex_file = CompilerTool.run(code)
    if hex_file.failed:
        raise Exception("Compilation failed after review. Check formatting or retry CodeModifierAgent.")

    # Step 6: ä»¿çœŸ
    result = SimulatorTool.run(hex_file)
    return result



æ¨¡å—è¯´æ˜ï¼š
Agent/Tool	è¯´æ˜
CodeGeneratorAgent	ä½¿ç”¨ GPT-4 ä¹‹ç±»æ¨¡å‹ç”Ÿæˆ C ç¨‹åºä»£ç ï¼ˆå¸¦æ³¨é‡Šï¼‰
CodeReviewTool	è°ƒç”¨ OpenAI Embedding + FAISS + LangChain RetrievalQA å®¡æŸ¥ä»£ç 
CodeModifierAgent	æå– CodeReview çš„â€œä¸¥é‡é—®é¢˜â€å¹¶ä¿®æ­£å¯¹åº”ä»£ç æ®µ
ControllerAgent	åˆ¤æ–­æ˜¯å¦è¿›å…¥ä¸‹ä¸€ä¸ªé˜¶æ®µï¼Œæˆ–é‡å› Code ä¿®æ­£
CompilerTool	ä½¿ç”¨ SDCC ç¼–è¯‘å™¨ç¼–è¯‘æˆ HEX
SimulatorTool	ä½¿ç”¨ Proteus ç­‰æ‰§è¡Œä»¿çœŸ
clean_code_for_sdcc	æ¸…ç†æ‰æ³¨é‡Šæ–‡æœ¬ã€éæ³•é¦–è¡Œç­‰ï¼Œç¡®ä¿æ ¼å¼åˆæ³•ï¼ˆéå¸¸å…³é”®ï¼‰

======================================================================================================================================================


å»ºè®®åŠ å…¥çŠ¶æ€è®°å½•å­—æ®µ
state = {
    "code_version": 1,
    "last_review_passed": False,
    "last_review_feedback": "",
    "compiler_success": None,
    "simulation_result": None,
}



å°†æ¯æ¬¡å®¡æŸ¥å¾—åˆ°çš„é”™è¯¯å†…å®¹è‡ªåŠ¨åŠ å…¥åˆ° RAG çŸ¥è¯†åº“ä¸­ï¼Œè¿™æ · RAG ä¼šéšç€ä½ é¡¹ç›®è¿è¡Œä¸æ–­â€œè¿›åŒ–â€â€”â€”å˜å¾—æ›´æ™ºèƒ½ã€æ›´æœ‰é’ˆå¯¹æ€§ã€‚

åŠ å…¥æ–¹å¼å»ºè®®ï¼ˆè‡ªåŠ¨é‡‡é›† + å¢é‡æ›´æ–°ï¼‰
ğŸ§© æ¯æ¬¡å®¡æŸ¥åæå–ç»“æ„åŒ–é”™è¯¯ï¼š
æ¯”å¦‚å·²æœ‰è¿™ç±»è¾“å‡ºï¼š
{
  "type": "critical",
  "line": 4,
  "code": "#include <stdio.h>",
  "issue": "8051 ä¸æ”¯æŒæ ‡å‡†åº“",
  "suggestion": "åˆ é™¤è¯¥å¤´æ–‡ä»¶ï¼Œæ”¹ç”¨å¹³å°ç‰¹å®šå®ç°ã€‚"
}
ä½ å¯ä»¥æå–æˆçŸ¥è¯†æ–‡æœ¬ï¼š
{
  "text": "8051 å¾®æ§åˆ¶å™¨ä¸æ”¯æŒ <stdio.h> ç­‰æ ‡å‡† C åº“ï¼Œåº”ä½¿ç”¨å¹³å°ç‰¹å®šå¤´æ–‡ä»¶æˆ–æ›¿ä»£å‡½æ•°ã€‚",
  "source": "auto-review",
  "tags": ["platform", "8051", "stdio"]
}
æŠ€æœ¯æµç¨‹å»ºè®®

ç»“æ„åŒ–æå–å®¡æŸ¥ç»“æœï¼š
ç”¨æ­£åˆ™ / JSONSchema æå–æ–‡æœ¬ä¸­çš„å»ºè®®å†…å®¹ã€‚

è¿‡æ»¤é‡å¤å†…å®¹ï¼š
ç”¨ embeddingï¼ˆOpenAI æˆ– SentenceTransformersï¼‰åšè¿‘ä¼¼å»é‡ã€‚

å¢é‡å†™å…¥ JSONL æ–‡ä»¶ï¼š
é™„åŠ åˆ° code_review_knowledge.jsonl ä¸­ã€‚

å®šæœŸé‡å»º FAISS ç´¢å¼•ï¼š
# é‡æ–°ç´¢å¼•ï¼ˆå¯æ¯Næ¬¡æˆ–æ¯æ—¥æ‰§è¡Œï¼‰
texts = load_jsonl("code_review_knowledge.jsonl")
vectorstore = FAISS.from_texts(texts, embedding=OpenAIEmbeddings())
vectorstore.save_local("code_review_8051_index")


æ•ˆæœ
ğŸš€ æ™ºèƒ½ä½“é€æ­¥â€œå­¦ä¹ â€ä½ å¸¸è§çš„åµŒå…¥å¼å¼€å‘é”™è¯¯
ğŸ” æ¯æ¬¡è¿è¡Œéƒ½å˜å¾—æ›´å¼ºå¤§
ğŸ§  é•¿æœŸèƒ½å½¢æˆä½ çš„ç§æœ‰ä»£ç å®¡æŸ¥çŸ¥è¯†ä½“ç³»


ç¤ºä¾‹ï¼š
å·²æˆåŠŸå°†ä»£ç å®¡æŸ¥ä¸­çš„é”™è¯¯å†…å®¹åŠ å…¥åˆ° RAG çŸ¥è¯†åº“ï¼ˆJSONL æ–‡ä»¶ï¼‰ä¸­ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š
{
  "id": "6e577656-c390-4946-aebe-27d5731b9b8b",
  "text": "8051 å¾®æ§åˆ¶å™¨ä¸æ”¯æŒ <stdio.h> ç­‰æ ‡å‡† C åº“ï¼Œåº”ä½¿ç”¨å¹³å°ç‰¹å®šå¤´æ–‡ä»¶æˆ–æ›¿ä»£å‡½æ•°ã€‚",
  "source": "code-review",
  "tags": ["8051", "stdio", "platform"]
}
ç°åœ¨å¯ä»¥ï¼š

å®šæœŸå°†æ‰€æœ‰ code reviewer è¾“å‡ºè‡ªåŠ¨è¿½åŠ åˆ°è¯¥ JSONL æ–‡ä»¶ï¼›
ç»“åˆ OpenAI Embeddings å’Œ FAISS æˆ– Chroma æ„å»ºå‘é‡æ•°æ®åº“ï¼›
ç”¨ä½œ LangChain çš„ VectorStoreRetriever æ”¯æŒä»£ç å®¡æŸ¥å‰çš„çŸ¥è¯†å¢å¼ºã€‚


code reviewer agentæ”¹è¿›ï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼š
æ”¹è¿›æç¤ºè¯ï¼š
åœ¨ CodeReviewTool çš„ prompt å‰åŠ ä¸€å¥ç³»ç»Ÿçº§æŒ‡ä»¤ï¼š
"åœ¨å¼€å§‹å®¡æŸ¥å‰ï¼Œå…ˆä»å†å²é”™è¯¯æ•°æ®åº“ï¼ˆRAGï¼‰ä¸­æ£€ç´¢ç›¸ä¼¼é”™è¯¯ä½œä¸ºå‚è€ƒï¼Œç„¶åå†ç»™å‡ºå®¡æŸ¥ç»“æœã€‚"

LangChain ç»“æ„å»ºè®®ï¼š
RetrievalQA.from_chain_type(
    llm=OpenAI(...),
    retriever=faiss_retriever,
    chain_type="stuff",
    chain_type_kwargs={"prompt": code_review_prompt_with_context}
)

======================================================================================================================================================

